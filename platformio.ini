[platformio]
default_envs = esp32_wroom32

; ============================================
; ESP32-WROOM-32 (SIN PSRAM)
; ============================================
[env:esp32_wroom32]
platform = espressif32
board = esp32dev
framework = arduino

; Especificar que es WROOM-32 (sin PSRAM)
board_build.mcu = esp32
board_build.variant = esp32

; Monitor serial
monitor_speed = 115200
monitor_filters = 
    esp32_exception_decoder
    colorize
    time

; Librerías necesarias
; (nextion_ui.cpp implementa comunicación serial directa, no requiere librería externa)
lib_deps = 

; ============= OPTIMIZACIÓN PARA WROOM-32 =============
build_flags = 
    ; Identificar que NO hay PSRAM
    -DBOARD_HAS_NO_PSRAM
    
    ; Debug level
    -DCORE_DEBUG_LEVEL=3
    
    ; Optimización máxima de velocidad
    -O3
    -ffast-math
    -funroll-loops
    -ftree-vectorize
    
    ; Stack para loop de Arduino
    -DARDUINO_LOOP_STACK_SIZE=8192
    
    ; Dual core habilitado
    -DCONFIG_FREERTOS_UNICORE=0
    
    ; Watchdog timer (usar valor por defecto del SDK = 5s)
    
    ; Optimizaciones del linker
    -ffunction-sections
    -fdata-sections
    -Wl,--gc-sections
    
    ; Usar IRAM eficientemente
    -DCONFIG_ESP32_IRAM_AS_8BIT_ACCESSIBLE_MEMORY
    
    ; Habilitar cache de instrucciones
    -DCONFIG_ESP32_INSTRUCTION_CACHE_SIZE_16KB

; Particiones optimizadas para 4MB Flash
board_build.partitions = default.csv

; ============= FRECUENCIAS MÁXIMAS =============
; CPU a 240 MHz (máximo)
board_build.f_cpu = 240000000L

; Flash a 80 MHz en modo QIO (máximo)
board_build.f_flash = 80000000L
board_build.flash_mode = qio

; Tamaño de Flash del WROOM-32
board_build.flash_size = 4MB

; ============= UPLOAD =============
upload_speed = 921600
upload_protocol = esptool

; Reset method
upload_resetmethod = nodemcu

; ============= BUILD OPTIMIZATIONS =============
build_unflags = 
    -Os          ; Remover optimización de tamaño
    -std=gnu++11 ; Remover estándar viejo

build_type = release

; ============================================
; VARIANTE: Performance Balanceado (RECOMENDADO)
; Mejor balance entre velocidad y consumo
; ============================================
[env:esp32_wroom32_balanced]
extends = env:esp32_wroom32
board_build.f_cpu = 160000000L

build_flags = 
    ${env:esp32_wroom32.build_flags}
    -O2  ; Optimización balanceada
    -DCONFIG_ESP32_DEFAULT_CPU_FREQ_160=y

; ============================================
; VARIANTE: Debug
; Para desarrollo y troubleshooting
; ============================================
[env:esp32_wroom32_debug]
extends = env:esp32_wroom32
build_type = debug

build_flags = 
    -DCORE_DEBUG_LEVEL=5
    -DDEBUG_ESP_PORT=Serial
    -DDEBUG_ESP_CORE
    -g
    -Og          ; Optimización para debugging
    -DBOARD_HAS_NO_PSRAM

monitor_filters = 
    esp32_exception_decoder
    time
    log2file
    colorize

; ============================================
; VARIANTE: Bajo Consumo
; Para operación con batería
; ============================================
[env:esp32_wroom32_lowpower]
extends = env:esp32_wroom32
board_build.f_cpu = 80000000L

build_flags = 
    ${env:esp32_wroom32.build_flags}
    -Os  ; Optimizar tamaño (menos consumo)
    -DCONFIG_ESP32_DEFAULT_CPU_FREQ_80=y
    -DCONFIG_PM_ENABLE=y