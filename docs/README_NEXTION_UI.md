# ๐ฑ Interfaz Nextion - BioSimulator Pro v1.0.0

## Documentaciรณn de la Experiencia de Usuario y Comunicaciรณn ESP32-Nextion
*รltima actualizaciรณn: 07.12.2025*

---

## ๐ รndice

1. [Resumen del Sistema](#resumen-del-sistema)
2. [Arquitectura de Comunicaciรณn](#arquitectura-de-comunicaciรณn)
3. [Mapa de Pรกginas](#mapa-de-pรกginas)
4. [Diagrama de Flujo de Usuario](#diagrama-de-flujo-de-usuario)
5. [Estructura de Cada Pรกgina](#estructura-de-cada-pรกgina)
6. [Protocolo de Comunicaciรณn](#protocolo-de-comunicaciรณn)
7. [Comandos y Eventos](#comandos-y-eventos)

---

## ๐ฏ Resumen del Sistema

El sistema utiliza una pantalla **Nextion NX4024T032** (320x240 pรญxeles) como interfaz de usuario. La comunicaciรณn es bidireccional vรญa UART a 115200 baudios.

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    ARQUITECTURA GENERAL                                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                          โ
โ   โโโโโโโโโโโโโโโโ         UART 115200          โโโโโโโโโโโโโโโโโโโโ    โ
โ   โ              โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโบ โ                  โ    โ
โ   โ   NEXTION    โ    TX/RX (GPIO 16/17)        โ     ESP32        โ    โ
โ   โ   Display    โ                              โ   WROOM-32       โ    โ
โ   โ  320 x 240   โ                              โ                  โ    โ
โ   โ              โ                              โ                  โ    โ
โ   โโโโโโโโโโโโโโโโ                              โโโโโโโโโโโโโโโโโโโโ    โ
โ         โ                                              โ                โ
โ         โ Muestra                                      โ Genera         โ
โ         โผ                                              โผ                โ
โ   โโโโโโโโโโโโโโโโ                              โโโโโโโโโโโโโโโโโโโโ    โ
โ   โ  Waveforms   โ                              โ  Seรฑales ECG     โ    โ
โ   โ  Controles   โ                              โ  EMG, PPG        โ    โ
โ   โ  Mรฉtricas    โ                              โ  DAC Output      โ    โ
โ   โโโโโโโโโโโโโโโโ                              โโโโโโโโโโโโโโโโโโโโ    โ
โ                                                                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ Arquitectura de Comunicaciรณn

### Flujo Bidireccional

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    COMUNICACIรN BIDIRECCIONAL                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                          โ
โ  โโโโโโโโโโโโโโโ                              โโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ   NEXTION   โ                              โ       ESP32         โ   โ
โ  โ   Display   โ                              โ                     โ   โ
โ  โโโโโโโโฌโโโโโโโ                              โโโโโโโโโโโโฌโโโโโโโโโโโ   โ
โ         โ                                                โ              โ
โ         โ  โโโโโโโโโโ EVENTOS (Touch) โโโโโโโโโโโโบ       โ              โ
โ         โ  0x65 [page] [id] [event] 0xFF 0xFF 0xFF       โ              โ
โ         โ                                                โ              โ
โ         โ  Ejemplo: Usuario toca "Play"                  โ              โ
โ         โ  0x65 05 04 01 FF FF FF                        โ              โ
โ         โ  (page=5, id=4, release)                       โ              โ
โ         โ                                                โ              โ
โ         โ  โโโโโโโโโโโ COMANDOS โโโโโโโโโโโโโโ          โ              โ
โ         โ  "add 1,0,150" + 0xFF 0xFF 0xFF                โ              โ
โ         โ                                                โ              โ
โ         โ  Ejemplo: Enviar punto al waveform             โ              โ
โ         โ  add 1,0,150 โ dibuja punto Y=150              โ              โ
โ         โ                                                โ              โ
โ         โผ                                                โผ              โ
โ  โโโโโโโโโโโโโโโโ                              โโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ Dibuja punto โ                              โ Genera seรฑal ECG    โ  โ
โ  โ en waveform  โ                              โ Escala a 0-211      โ  โ
โ  โโโโโโโโโโโโโโโโ                              โ Envรญa cada 10ms     โ  โ
โ                                                โโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐บ๏ธ Mapa de Pรกginas

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                        MAPA DE NAVEGACIรN                                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                          โ
โ                         โโโโโโโโโโโโโโโ                                  โ
โ                         โ   PORTADA   โ                                  โ
โ                         โ   Page 0    โ                                  โ
โ                         โ  (Splash)   โ                                  โ
โ                         โโโโโโโโฌโโโโโโโ                                  โ
โ                                โ bt_comenzar (page menu)                 โ
โ                                โผ                                         โ
โ                         โโโโโโโโโโโโโโโ                                  โ
โ                         โ    MENU     โ                                  โ
โ                         โ   Page 1    โ                                  โ
โ                         โ ECG EMG PPG โ โโโโ bt_atras (desde *_SIM)     โ
โ                         โโโโโโโโฌโโโโโโโ                                  โ
โ              bt_ecg/emg/ppg (sel_signal.val) + bt_ir                     โ
โ                    โโโโโโโโโโโโโผโโโโโโโโโโโโ                             โ
โ                    โ           โ           โ                             โ
โ                    โผ           โผ           โผ                             โ
โ             โโโโโโโโโโโโ โโโโโโโโโโโโ โโโโโโโโโโโโ                       โ
โ             โ ECG_SIM  โ โ EMG_SIM  โ โ PPG_SIM  โ                       โ
โ             โ  Page 2  โ โ  Page 3  โ โ  Page 4  โ                       โ
โ             โ9 condic. โ โ10 condic.โ โ7 condic. โ                       โ
โ             โโโโโโฌโโโโโโ โโโโโโฌโโโโโโ โโโโโโฌโโโโโโ                       โ
โ              bt_ir (printh if sel_*.val>=0)                              โ
โ                  โ            โ            โ                             โ
โ                  โผ            โผ            โผ                             โ
โ             โโโโโโโโโโโโ โโโโโโโโโโโโ โโโโโโโโโโโโ                       โ
โ             โ WAVEFORM โ โ WAVEFORM โ โ WAVEFORM โ                       โ
โ             โ   ECG    โ โ   EMG    โ โ   PPG    โ                       โ
โ             โ  Page 5  โ โ  Page 8  โ โ  Page 11 โ                       โ
โ             โ+Controls โ โ+Controls โ โ+Controls โ                       โ
โ             โโโโโโฌโโโโโโ โโโโโโฌโโโโโโ โโโโโโฌโโโโโโ                       โ
โ                  โ            โ            โ                             โ
โ              โโโโโดโโโโ    โโโโโดโโโโ    โโโโโดโโโโ                         โ
โ              โผ       โผ    โผ       โผ    โผ       โผ                         โ
โ          โโโโโโโโโ โโโโโโ โโโโโโโโโ โโโโโโ โโโโโโโโโ โโโโโโ             โ
โ          โVALORESโ โPARAโ โVALORESโ โPARAโ โVALORESโ โPARAโ             โ
โ          โ Page6 โ โ 7  โ โ Page9 โ โ 10 โ โPage 12โ โ 13 โ             โ
โ          โโโโโโโโโ โโโโโโ โโโโโโโโโ โโโโโโ โโโโโโโโโ โโโโโโ             โ
โ                                                                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ Diagrama de Flujo de Usuario

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    FLUJO DE EXPERIENCIA DE USUARIO                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                          โ
โ  โโโโโโโโโโโ                                                             โ
โ  โ INICIO  โ                                                             โ
โ  โโโโโโฌโโโโโ                                                             โ
โ       โ                                                                  โ
โ       โผ                                                                  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโ                                                 โ
โ  โ PORTADA (Page 0)    โ                                                 โ
โ  โ "BioSimulator Pro"  โ                                                 โ
โ  โ [Comenzar]          โ                                                 โ
โ  โโโโโโโโโโโโฌโโโโโโโโโโโ                                                 โ
โ             โ Touch: page menu                                           โ
โ             โผ                                                            โ
โ  โโโโโโโโโโโโโโโโโโโโโโโ                                                 โ
โ  โ MENU (Page 1)       โ โโโโโ bt_atras (page menu)                     โ
โ  โ [ECG] [EMG] [PPG]   โ                                                 โ
โ  โ [Atrรกs] [Ir]        โ                                                 โ
โ  โโโโโโโโโโโโฌโโโโโโโโโโโ                                                 โ
โ             โ 1. Selecciona seรฑal (sel_signal.val=1/2/3)                 โ
โ             โ 2. Toca [Ir] โ if(sel_signal.val) page *_sim               โ
โ             โผ                                                            โ
โ  โโโโโโโโโโโโโโโโโโโโโโโ                                                 โ
โ  โ *_SIM (Page 2/3/4)  โ                                                 โ
โ  โ Lista condiciones   โ                                                 โ
โ  โ [Normal] [Taqui]... โ                                                 โ
โ  โ [Atrรกs] [Ir]        โ                                                 โ
โ  โโโโโโโโโโโโฌโโโโโโโโโโโ                                                 โ
โ       โโโโโโโดโโโโโโ                                                      โ
โ       โผ           โผ                                                      โ
โ  [Atrรกs]    1. Toca condiciรณn (sel_*.val=0-9)                           โ
โ  page menu  2. Toca [Ir] โ if(sel_*.val>=0) printh 65...                โ
โ             3. ESP32 recibe โ page waveform_*                            โ
โ                    โ                                                     โ
โ                    โผ                                                     โ
โ       โโโโโโโโโโโโโโโโโโโโโโโโโโโ                                        โ
โ       โ WAVEFORM_* (5/8/11)     โ                                        โ
โ       โ โโโโโโโโโโโโโโโโโโโโโโโ โ                                        โ
โ       โ โ   ~~~~/\~~~~        โ โ                                        โ
โ       โ โโโโโโโโโโโโโโโโโโโโโโโ โ                                        โ
โ       โ [โถPlay][โธPause][โนStop] โ                                        โ
โ       โ [Valores] [Parรกmetros]  โ                                        โ
โ       โโโโโโโโโโโโโฌโโโโโโโโโโโโโโ                                        โ
โ            โโโโโโโโดโโโโโโโฌโโโโโโโโโโโ                                    โ
โ            โผ             โผ          โผ                                    โ
โ       โโโโโโโโโโ   โโโโโโโโโโโ โโโโโโโโโโโโ                             โ
โ       โ "Stop" โ   โ"Valores"โ โ"Parรกmetr"โ                             โ
โ       โprinth  โ   โprinth   โ โ printh   โ                             โ
โ       โโโโโฌโโโโโ   โโโโโโฌโโโโโ โโโโโโฌโโโโโโ                             โ
โ           โ             โ           โ                                    โ
โ           โผ             โผ           โผ                                    โ
โ      page menu    โโโโโโโโโโโ โโโโโโโโโโโโ                              โ
โ                   โ VALORES โ โPARรMETROSโ                              โ
โ                   โ (6/9/12)โ โ (7/10/13)โ                              โ
โ                   โ HR: 72  โ โ Sliders: โ                              โ
โ                   โ RR: 833 โ โ  HR โโโ  โ                              โ
โ                   โ [Cerrar]โ โ  Amp โโโ โ                              โ
โ                   โโโโโโฌโโโโโ โ [Reset]  โ                              โ
โ                        โ      โ [Aplicar]โ                              โ
โ                        โ      โ [Cancel] โ                              โ
โ                        โ      โโโโโโฌโโโโโโ                               โ
โ                        โ           โ                                     โ
โ                   printh 65...  printh 65...                             โ
โ                   ESP32 โ page waveform_*                                โ
โ       โ         โ    โ [Actualizar]    โ         โ             โ        โ
โ       โ         โ    โโโโโโโโโโฌโโโโโโโโโ         โ             โ        โ
โ       โ         โ             โ bt_act           โ             โ        โ
โ       โ         โ             โโโโโโโโโโโโโโโโโโโโ             โ        โ
โ       โ         โ                                              โ        โ
โ       โโโโโโโโโโโดโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ        โ
โ                                                                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ Estructura de Cada Pรกgina

### Page 0: PORTADA
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                                        โ
โ         BioSimulator Pro               โ
โ              v1.0.0                    โ
โ                                        โ
โ          โโโโโโโโโโโโโโโโ              โ
โ          โ  COMENZAR    โ ID: 1       โ
โ          โ  (hotspot)   โ              โ
โ          โโโโโโโโโโโโโโโโ              โ
โ                                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### Page 1: MENU
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ (ID:4)              โ (ID:5)        โ
โ  bt_atras              bt_ir           โ
โ                                        โ
โ   โโโโโโโโโโโ โโโโโโโโโโโ โโโโโโโโโโโ  โ
โ   โ   ECG   โ โ   EMG   โ โ   PPG   โ  โ
โ   โ  ID: 1  โ โ  ID: 2  โ โ  ID: 3  โ  โ
โ   โโโโโโโโโโโ โโโโโโโโโโโ โโโโโโโโโโโ  โ
โ                                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### Page 2: ECG_SIM (Selecciรณn de Condiciรณn ECG)
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ (ID:0)              โ (ID:1)        โ
โ  bt_atras              bt_ir           โ
โ                                        โ
โ  โโโโโโโโโโโโโโ  โโโโโโโโโโโโโโ        โ
โ  โ  Normal    โ  โ Taquicardiaโ        โ
โ  โ   ID: 4    โ  โ   ID: 5    โ        โ
โ  โโโโโโโโโโโโโโ  โโโโโโโโโโโโโโ        โ
โ  โโโโโโโโโโโโโโ  โโโโโโโโโโโโโโ        โ
โ  โBradicardia โ  โ  Fib.Aur.  โ        โ
โ  โ   ID: 6    โ  โ   ID: 7    โ        โ
โ  โโโโโโโโโโโโโโ  โโโโโโโโโโโโโโ        โ
โ  โโโโโโโโโโโโโโ  โโโโโโโโโโโโโโ        โ
โ  โ  Fib.Vent. โ  โ Extrasรญst. โ        โ
โ  โ   ID: 8    โ  โ   ID: 9    โ        โ
โ  โโโโโโโโโโโโโโ  โโโโโโโโโโโโโโ        โ
โ  โโโโโโโโโโโโโโ  โโโโโโโโโโโโโโ        โ
โ  โ Bloq.Rama  โ  โ Elev. ST   โ        โ
โ  โ   ID: 10   โ  โ   ID: 11   โ        โ
โ  โโโโโโโโโโโโโโ  โโโโโโโโโโโโโโ        โ
โ  โโโโโโโโโโโโโโ                        โ
โ  โ Depre. ST  โ  sel_ecg: ID 3         โ
โ  โ   ID: 12   โ  (variable number)     โ
โ  โโโโโโโโโโโโโโ                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

Mapeo de condiciones:
  ID 4  โ Condiciรณn 0 (Normal)
  ID 5  โ Condiciรณn 1 (Taquicardia)
  ID 6  โ Condiciรณn 2 (Bradicardia)
  ID 7  โ Condiciรณn 3 (Fibrilaciรณn Auricular)
  ID 8  โ Condiciรณn 4 (Fibrilaciรณn Ventricular)
  ID 9  โ Condiciรณn 5 (Extrasรญstole/PVC)
  ID 10 โ Condiciรณn 6 (Bloqueo de Rama)
  ID 11 โ Condiciรณn 7 (Elevaciรณn ST)
  ID 12 โ Condiciรณn 8 (Depresiรณn ST)
```

### Page 3: EMG_SIM (Selecciรณn de Condiciรณn EMG)
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ (ID:12)             โ (ID:13)       โ
โ  bt_atras              bt_ir           โ
โ                                        โ
โ  โโโโโโโโโโโโโโ  โโโโโโโโโโโโโโ        โ
โ  โ  Reposo    โ  โ   Temblor  โ        โ
โ  โ   ID: 1    โ  โ   ID: 6    โ        โ
โ  โโโโโโโโโโโโโโ  โโโโโโโโโโโโโโ        โ
โ  โโโโโโโโโโโโโโ  โโโโโโโโโโโโโโ        โ
โ  โContr. Leve โ  โ  Miopatรญa  โ        โ
โ  โ   ID: 2    โ  โ   ID: 7    โ        โ
โ  โโโโโโโโโโโโโโ  โโโโโโโโโโโโโโ        โ
โ  โโโโโโโโโโโโโโ  โโโโโโโโโโโโโโ        โ
โ  โContr.Moder.โ  โ Neuropatรญa โ        โ
โ  โ   ID: 3    โ  โ   ID: 8    โ        โ
โ  โโโโโโโโโโโโโโ  โโโโโโโโโโโโโโ        โ
โ  โโโโโโโโโโโโโโ  โโโโโโโโโโโโโโ        โ
โ  โContr.Fuerteโ  โFasciculac. โ        โ
โ  โ   ID: 4    โ  โ   ID: 9    โ        โ
โ  โโโโโโโโโโโโโโ  โโโโโโโโโโโโโโ        โ
โ  โโโโโโโโโโโโโโ  โโโโโโโโโโโโโโ        โ
โ  โContr.Mรกximaโ  โ   Fatiga   โ        โ
โ  โ   ID: 5    โ  โ   ID: 10   โ        โ
โ  โโโโโโโโโโโโโโ  โโโโโโโโโโโโโโ        โ
โ                                        โ
โ               sel_emg: ID 11           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

Mapeo de condiciones:
  ID 1  โ Condiciรณn 0 (Reposo)
  ID 2  โ Condiciรณn 1 (Contracciรณn Leve)
  ID 3  โ Condiciรณn 2 (Contracciรณn Moderada)
  ID 4  โ Condiciรณn 3 (Contracciรณn Fuerte)
  ID 5  โ Condiciรณn 4 (Contracciรณn Mรกxima)
  ID 6  โ Condiciรณn 5 (Temblor)
  ID 7  โ Condiciรณn 6 (Miopatรญa)
  ID 8  โ Condiciรณn 7 (Neuropatรญa)
  ID 9  โ Condiciรณn 8 (Fasciculaciรณn)
  ID 10 โ Condiciรณn 9 (Fatiga)
```

### Page 4: PPG_SIM (Selecciรณn de Condiciรณn PPG)
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ (ID:9)              โ (ID:10)       โ
โ  bt_atras              bt_ir           โ
โ                                        โ
โ  โโโโโโโโโโโโ โโโโโโโโโโโโ โโโโโโโโโโโโโ
โ  โ  Normal  โ โ Arritmia โ โSPO2 Bajo โโ
โ  โ  ID: 1   โ โ  ID: 3   โ โ  ID: 4   โโ
โ  โโโโโโโโโโโโ โโโโโโโโโโโโ โโโโโโโโโโโโโ
โ  โโโโโโโโโโโโ โโโโโโโโโโโโ โโโโโโโโโโโโโ
โ  โPerf.Dรฉbilโ โPerf.Fuertโ โVasoconst.โโ
โ  โ  ID: 5   โ โ  ID: 6   โ โ  ID: 7   โโ
โ  โโโโโโโโโโโโ โโโโโโโโโโโโ โโโโโโโโโโโโโ
โ        โโโโโโโโโโโโโโโโ                โ
โ        โRuido Movim.  โ                โ
โ        โ    ID: 8     โ                โ
โ        โโโโโโโโโโโโโโโโ                โ
โ               sel_ppg: ID 2            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

Mapeo de condiciones:
  ID 1 โ Condiciรณn 0 (Normal)
  ID 3 โ Condiciรณn 1 (Arritmia)
  ID 4 โ Condiciรณn 2 (SPO2 Bajo)
  ID 5 โ Condiciรณn 3 (Perfusiรณn Dรฉbil)
  ID 6 โ Condiciรณn 4 (Perfusiรณn Fuerte)
  ID 7 โ Condiciรณn 5 (Vasoconstricciรณn)
  ID 8 โ Condiciรณn 6 (Ruido por Movimiento)
```

### Pages 5, 6, 7: WAVEFORM (ECG_WAVE, EMG_WAVE, PPG_WAVE)
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ โ                                    โ โ
โ โ           WAVEFORM                 โ โ
โ โ         399 x 211 px               โ โ
โ โ            ID: 1                   โ โ
โ โ      ~~~~~/\~~~~~~/\~~~~~          โ โ
โ โ                                    โ โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                        โ
โ โโโโโโโโโโโ        โโโโโโโโโโโโโโโโโโโ โ
โ โ Valores โ        โ   Parรกmetros    โ โ
โ โ  ID: 2  โ        โ      ID: 3      โ โ
โ โโโโโโโโโโโ        โโโโโโโโโโโโโโโโโโโ โ
โ                                        โ
โ    โโโโโ    โโโโโ    โโโโโ             โ
โ    โ โถ โ    โ โธ โ    โ โน โ             โ
โ    โID4โ    โID5โ    โID6โ             โ
โ    โโโโโ    โโโโโ    โโโโโ             โ
โ    Play     Pause    Stop              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

Componentes:
  ID 1: Waveform (ecg/emg/ppg)
  ID 2: v_actual (hotspot) โ popup valores
  ID 3: parametros (hotspot) โ popup params
  ID 4: play (hotspot) โ iniciar seรฑal
  ID 5: pause (hotspot) โ pausar seรฑal
  ID 6: stop (hotspot) โ detener y volver a menรบ
```

### Page 8: POPUP VALORES ECG
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ p0 (picture - fondo popup)       โ  โ
โ  โ                       โโโโโโโโโโ โ  โ
โ  โ                       โbt_act  โ โ  โ
โ  โ                       โ ID: 1  โ โ  โ
โ  โ                       โโโโโโโโโโ โ  โ
โ  โ                                  โ  โ
โ  โ   HR:  โโโโโโโโโโโ               โ  โ
โ  โ        โ val_hr  โ ID: 2 number  โ  โ
โ  โ        โ   72    โ               โ  โ
โ  โ        โโโโโโโโโโโ               โ  โ
โ  โ   RR:  โโโโโโโโโโโ               โ  โ
โ  โ        โ val_rr  โ ID: 3 number  โ  โ
โ  โ        โ  833    โ               โ  โ
โ  โ        โโโโโโโโโโโ               โ  โ
โ  โ   QRS: โโโโโโโโโโโ               โ  โ
โ  โ        โ val_qrs โ ID: 4 xfloat  โ  โ
โ  โ        โ  1.2    โ (vvs0=1)      โ  โ
โ  โ        โโโโโโโโโโโ               โ  โ
โ  โ   ST:  โโโโโโโโโโโ               โ  โ
โ  โ        โ val_st  โ ID: 5 xfloat  โ  โ
โ  โ        โ  0.0    โ (vvs0=1)      โ  โ
โ  โ        โโโโโโโโโโโ               โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ก Protocolo de Comunicaciรณn

### Formato de Eventos Nextion โ ESP32

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    FORMATO DE EVENTO TOUCH                               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                          โ
โ   Byte 0    Byte 1    Byte 2    Byte 3    Byte 4-6                      โ
โ  โโโโโโโโโโฌโโโโโโโโโโฌโโโโโโโโโโโฌโโโโโโโโโโฌโโโโโโโโโโโโโโ                โ
โ  โ  0x65  โ  Page   โComponent โ  Event  โ 0xFF FF FF  โ                โ
โ  โ (tipo) โ   ID    โ    ID    โ (1=rel) โ (terminador)โ                โ
โ  โโโโโโโโโโดโโโโโโโโโโดโโโโโโโโโโโดโโโโโโโโโโดโโโโโโโโโโโโโโ                โ
โ                                                                          โ
โ   Ejemplo: Usuario toca "Play" en ecg_wave                              โ
โ                                                                          โ
โ   0x65     0x05      0x04       0x01      0xFF 0xFF 0xFF                โ
โ   โ        โ         โ          โ                                        โ
โ   โ        โ         โ          โโโ Release event                        โ
โ   โ        โ         โโโ Component ID = 4 (play)                         โ
โ   โ        โโโ Page ID = 5 (ecg_wave)                                    โ
โ   โโโ Touch event code                                                   โ
โ                                                                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### Formato de Comandos ESP32 โ Nextion

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    COMANDOS PRINCIPALES                                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                          โ
โ   NAVEGACIรN:                                                            โ
โ   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                           โ
โ   โ  page <n>               Ir a pรกgina n   โ                           โ
โ   โ  Ejemplo: "page 5" + 0xFF 0xFF 0xFF     โ                           โ
โ   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                           โ
โ                                                                          โ
โ   WAVEFORM:                                                              โ
โ   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                           โ
โ   โ  add <id>,<ch>,<val>    Agregar punto   โ                           โ
โ   โ  Ejemplo: "add 1,0,150" + 0xFF 0xFF 0xFFโ                           โ
โ   โ                                         โ                           โ
โ   โ  cle <id>,<ch>          Limpiar canal   โ                           โ
โ   โ  Ejemplo: "cle 1,0" + 0xFF 0xFF 0xFF    โ                           โ
โ   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                           โ
โ                                                                          โ
โ   ACTUALIZAR VALORES:                                                    โ
โ   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                           โ
โ   โ  <comp>.val=<n>         Nรบmero entero   โ                           โ
โ   โ  Ejemplo: "val_hr.val=72"               โ                           โ
โ   โ                                         โ                           โ
โ   โ  <comp>.txt="<s>"       Texto           โ                           โ
โ   โ  Ejemplo: "val_qrs.txt=\"1.2\""         โ                           โ
โ   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                           โ
โ                                                                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## โก Comandos y Eventos

### Tabla de Eventos UI

| Pรกgina | ID | Componente | UIEvent | Acciรณn ESP32 |
|--------|-----|------------|---------|--------------|
| 0 | 1 | bt_comenzar | BUTTON_COMENZAR | โ Ir a MENU |
| 1 | 1 | bt_ecg | BUTTON_ECG | Seleccionar ECG |
| 1 | 2 | bt_emg | BUTTON_EMG | Seleccionar EMG |
| 1 | 3 | bt_ppg | BUTTON_PPG | Seleccionar PPG |
| 1 | 5 | bt_ir | BUTTON_IR | โ Ir a *_SIM |
| 2 | 4-12 | bt_* | BUTTON_CONDITION | Seleccionar condiciรณn ECG |
| 2 | 1 | bt_ir | BUTTON_IR | โ Ir a ECG_WAVE |
| 5,6,7 | 4 | play | BUTTON_START | Iniciar seรฑal |
| 5,6,7 | 5 | pause | BUTTON_PAUSE | Pausar seรฑal |
| 5,6,7 | 6 | stop | BUTTON_STOP | Detener โ Menรบ |
| 5,6,7 | 2 | v_actual | BUTTON_VALORES | Mostrar popup |

### Frecuencias de Actualizaciรณn

| Tarea | Frecuencia | Intervalo |
|-------|------------|-----------|
| Waveform | 100 Hz | 10 ms |
| Mรฉtricas | 4 Hz | 250 ms |
| UI General | 10 Hz | 100 ms |

---

## ๐ง Configuraciรณn del Waveform

### Atributos Nextion Editor

| Atributo | Valor | Descripciรณn |
|----------|-------|-------------|
| `w` | 399 | Ancho en pรญxeles |
| `h` | 211 | Alto en pรญxeles |
| `ch` | 1 | Nรบmero de canales |
| `bco` | 0 | Color fondo (negro) |
| `gdc` | 1024 | Color cuadrรญcula (verde oscuro) |
| `gdw` | 40 | Ancho cuadrรญcula |
| `gdh` | 35 | Alto cuadrรญcula |
| `pco0` | 2016 | Color seรฑal (verde brillante) |
| `dis` | 10 | Distancia scroll |

### Escalado de Seรฑal

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    ESCALADO DE SEรAL                                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                          โ
โ   Seรฑal ECG (modelo)           DAC (ESP32)            Nextion            โ
โ   โโโโโโโโโโโโโโโโโ           โโโโโโโโโโโโโ          โโโโโโโโโ           โ
โ   -1.5 mV a +2.5 mV    โ      0 a 255         โ      10 a 201            โ
โ                                                                          โ
โ   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ   โ                                                                 โ   โ
โ   โ   valorDAC = (seรฑalMV + 1.5) * (255 / 4.0)                      โ   โ
โ   โ                                                                 โ   โ
โ   โ   valorDisplay = map(valorDAC, 0, 255, 10, WAVEFORM_HEIGHT-10)  โ   โ
โ   โ                                                                 โ   โ
โ   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                          โ
โ   El margen de 10px evita que la seรฑal toque los bordes                 โ
โ                                                                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## โ๏ธ REGLAS CRรTICAS DE IMPLEMENTACIรN

### ๐ด NUNCA mezclar `page` + `printh` en el mismo Touch Release Event

```
โ INCORRECTO (causa doble navegaciรณn):
Touch Release Event del bt_ir:
if(sel_ecg.val>=0)
{
  printh 65 02 02 01 FF FF FF
  page waveform_ecg              // โ๏ธ CONFLICTO!
}

โ CORRECTO:
Touch Release Event del bt_ir:
if(sel_ecg.val>=0)
{
  printh 65 02 02 01 FF FF FF    // ESP32 maneja la navegaciรณn
}
```

### ๐ Divisiรณn de responsabilidades

| Pรกginas | Navegaciรณn | Touch Release Events |
|---------|-----------|---------------------|
| **0-4** (PORTADA, MENU, *_SIM) | **Nextion controla** | Solo `page X` y asignaciones `sel_*.val` |
| **5-13** (WAVEFORM, VALORES, PARAMETROS) | **ESP32 controla** | Solo `printh 65...` |

### ๐ฏ Lรณgica especรญfica por pรกgina

**PรGINA 0 - PORTADA:**
- bt_comenzar โ `page menu`

**PรGINA 1 - MENU:**
- bt_ecg โ `sel_signal.val=1; bt_ecg.val=1; bt_emg.val=0; bt_ppg.val=0`
- bt_emg โ `sel_signal.val=2; bt_ecg.val=0; bt_emg.val=1; bt_ppg.val=0`
- bt_ppg โ `sel_signal.val=3; bt_ecg.val=0; bt_emg.val=0; bt_ppg.val=1`
- bt_atras โ `page portada`
- bt_ir โ `if(sel_signal.val==1){page ecg_sim} if(sel_signal.val==2){page emg_sim} if(sel_signal.val==3){page ppg_sim}`

**PรGINAS 2, 3, 4 - *_SIM (Selecciรณn de Condiciรณn):**
- **Botones condiciรณn (dual-state)**: Solo `sel_*.val=X` y `printh 65 0X 0X 01 FF FF FF` (SIN page, SIN lรณgica extra)
  - ECG (pรกgina 2): bt_nom (ID 4), bt_taq (5), bt_bra (6), bt_fa (7), bt_fv (8), bt_pvc (9), bt_brb (10), bt_stup (11), bt_stdn (12)
  - EMG (pรกgina 3): bt_reposo (1), bt_leve (2), bt_moderada (3), bt_fuerte (4), bt_maxima (5), bt_temblor (6), bt_miopatia (7), bt_neuropatia (8), bt_fasc (9), bt_fatiga (10)
  - PPG (pรกgina 4): bt_nom (1), bt_arr (2), bt_spo2 (3), bt_lowp (4), bt_highp (5), bt_vasc (6), bt_art (7)
- **bt_atras** โ `page menu`
- **bt_ir** โ `if(sel_*.val>=0){printh 65 0X 0X 01 FF FF FF}` (ESP32 decide pรกgina destino)
- **Selecciรณn รบnica enforced por ESP32**: Al recibir evento de condiciรณn, ESP32 limpia todos los botones (`val=0`, `pic=0`, `pic2=0` para dual-state) y solo marca el elegido.

**PรGINAS 5, 8, 11 - WAVEFORM_*:**
- Todos los botones โ `printh 65 0X 0X 01 FF FF FF`
- ESP32 maneja toda la lรณgica de navegaciรณn

**PรGINAS 6, 7, 9, 10, 12, 13 - POPUPS:**
- Todos los botones/sliders โ `printh 65 0X 0X 01 FF FF FF`
- xfloat displays en PARAMETROS โ `n_*.val=h_*.val` (actualizaciรณn local)
- ESP32 cierra popups con `goToPage(NextionPage::WAVEFORM_*)`

### ๐ง Tipo de componente vs Cรณdigo ESP32

**El tipo de componente Nextion (button/hotspot/dual-state) NO afecta el cรณdigo ESP32:**

```cpp
// ESP32 solo ve el ID, no el tipo:
case 2:  // bt_act (puede ser button, hotspot, dual-state)
    uiEvent = UIEvent::BUTTON_BACK_POPUP;
    break;
```

**Lo que importa:**
- โ ID correcto del componente
- โ Touch Release Event correcto
- โ El tipo visual (button/hotspot/dual-state) es irrelevante para ESP32

---

## ๐ Referencias

- **Nextion Instruction Set**: https://nextion.tech/instruction-set/
- **ESP32 DAC**: Resoluciรณn 8-bit (0-255), salida 0-3.3V
- **UART**: 115200 baudios, 8N1

---

*Documentaciรณn BioSimulator Pro v1.0.0*
*รltima actualizaciรณn: Diciembre 2025*
