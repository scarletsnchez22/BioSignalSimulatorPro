<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 950 750">
  <defs>
    <marker id="arrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#2c3e50"/>
    </marker>
    <marker id="arrowGreen" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#27ae60"/>
    </marker>
    <linearGradient id="gradHeader" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#2c3e50"/>
      <stop offset="100%" style="stop-color:#34495e"/>
    </linearGradient>
  </defs>
  
  <!-- Título -->
  <text x="475" y="30" font-family="Arial, sans-serif" font-size="18" font-weight="bold" text-anchor="middle" fill="#2c3e50">
    Arquitectura de Comunicación WebSocket
  </text>
  <text x="475" y="50" font-family="Arial, sans-serif" font-size="12" text-anchor="middle" fill="#7f8c8d">
    Sistema de Streaming en Tiempo Real para Aplicación Web
  </text>
  
  <!-- ESP32 Server -->
  <rect x="50" y="80" width="280" height="280" rx="10" fill="#f8f9fa" stroke="#3498db" stroke-width="2"/>
  <rect x="50" y="80" width="280" height="35" rx="10" fill="url(#gradHeader)"/>
  <text x="190" y="103" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="white">ESP32-WROOM-32</text>
  
  <!-- Componentes ESP32 -->
  <rect x="70" y="130" width="110" height="50" rx="5" fill="#3498db" stroke="#2980b9" stroke-width="1"/>
  <text x="125" y="152" font-family="Arial, sans-serif" font-size="10" font-weight="bold" text-anchor="middle" fill="white">SignalEngine</text>
  <text x="125" y="168" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#ecf0f1">generateSample()</text>
  
  <rect x="200" y="130" width="110" height="50" rx="5" fill="#9b59b6" stroke="#8e44ad" stroke-width="1"/>
  <text x="255" y="152" font-family="Arial, sans-serif" font-size="10" font-weight="bold" text-anchor="middle" fill="white">WiFiServer</text>
  <text x="255" y="168" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#ecf0f1">AsyncWebSocket</text>
  
  <rect x="70" y="200" width="240" height="70" rx="5" fill="#fff" stroke="#e0e0e0" stroke-width="1"/>
  <text x="90" y="218" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="#2c3e50">Buffer de Transmisión</text>
  <text x="90" y="235" font-family="Arial, sans-serif" font-size="9" fill="#7f8c8d">• Ring buffer 256 muestras</text>
  <text x="90" y="250" font-family="Arial, sans-serif" font-size="9" fill="#7f8c8d">• Formato JSON compacto</text>
  <text x="90" y="265" font-family="Arial, sans-serif" font-size="9" fill="#7f8c8d">• Batch cada 50ms (20 Hz)</text>
  
  <rect x="70" y="285" width="240" height="55" rx="5" fill="#ecf0f1" stroke="#bdc3c7" stroke-width="1"/>
  <text x="90" y="303" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="#2c3e50">Protocolo de Streaming</text>
  <text x="90" y="320" font-family="Courier New" font-size="9" fill="#8e44ad">{"t":"ecg","v":0.85,"ts":1234}</text>
  <text x="90" y="335" font-family="Arial, sans-serif" font-size="8" fill="#7f8c8d">t: tipo | v: valor mV | ts: timestamp</text>
  
  <!-- Canal WebSocket -->
  <rect x="360" y="150" width="230" height="180" rx="8" fill="#eef7ff" stroke="#3498db" stroke-width="2" stroke-dasharray="5,5"/>
  <text x="475" y="175" font-family="Arial, sans-serif" font-size="12" font-weight="bold" text-anchor="middle" fill="#2980b9">Canal WebSocket</text>
  <text x="475" y="195" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#7f8c8d">ws://192.168.4.1/ws</text>
  
  <!-- Flechas bidireccionales -->
  <line x1="330" y1="200" x2="360" y2="200" stroke="#27ae60" stroke-width="3" marker-end="url(#arrowGreen)"/>
  <text x="345" y="195" font-family="Arial, sans-serif" font-size="8" fill="#27ae60">DATA</text>
  
  <line x1="360" y1="280" x2="330" y2="280" stroke="#e74c3c" stroke-width="2" marker-end="url(#arrow)"/>
  <text x="345" y="275" font-family="Arial, sans-serif" font-size="8" fill="#e74c3c">CMD</text>
  
  <!-- Flujo dentro del canal -->
  <g transform="translate(380, 210)">
    <rect x="0" y="0" width="80" height="30" rx="3" fill="#27ae60"/>
    <text x="40" y="18" font-family="Arial, sans-serif" font-size="9" font-weight="bold" text-anchor="middle" fill="white">Stream →</text>
    <text x="40" y="28" font-family="Arial, sans-serif" font-size="7" text-anchor="middle" fill="#ecf0f1">100 msg/s</text>
  </g>
  <g transform="translate(490, 210)">
    <rect x="0" y="0" width="80" height="30" rx="3" fill="#e74c3c"/>
    <text x="40" y="18" font-family="Arial, sans-serif" font-size="9" font-weight="bold" text-anchor="middle" fill="white">← Control</text>
    <text x="40" y="28" font-family="Arial, sans-serif" font-size="7" text-anchor="middle" fill="#ecf0f1">Esporádico</text>
  </g>
  
  <text x="475" y="270" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#7f8c8d">Full-duplex persistent</text>
  <text x="475" y="285" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#7f8c8d">connection</text>
  <text x="475" y="310" font-family="Arial, sans-serif" font-size="10" font-weight="bold" text-anchor="middle" fill="#2980b9">Latencia: &lt;50 ms</text>
  
  <!-- Flechas al navegador -->
  <line x1="590" y1="200" x2="620" y2="200" stroke="#27ae60" stroke-width="3" marker-end="url(#arrowGreen)"/>
  <line x1="620" y1="280" x2="590" y2="280" stroke="#e74c3c" stroke-width="2" marker-end="url(#arrow)"/>
  
  <!-- Navegador Web -->
  <rect x="620" y="80" width="300" height="280" rx="10" fill="#f8f9fa" stroke="#e67e22" stroke-width="2"/>
  <rect x="620" y="80" width="300" height="35" rx="10" fill="#e67e22"/>
  <text x="770" y="103" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="white">Navegador Web</text>
  
  <!-- Componentes navegador -->
  <rect x="640" y="130" width="130" height="50" rx="5" fill="#f39c12" stroke="#d68910" stroke-width="1"/>
  <text x="705" y="152" font-family="Arial, sans-serif" font-size="10" font-weight="bold" text-anchor="middle" fill="white">WebSocket API</text>
  <text x="705" y="168" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#ecf0f1">onmessage()</text>
  
  <rect x="780" y="130" width="120" height="50" rx="5" fill="#1abc9c" stroke="#16a085" stroke-width="1"/>
  <text x="840" y="152" font-family="Arial, sans-serif" font-size="10" font-weight="bold" text-anchor="middle" fill="white">Chart.js</text>
  <text x="840" y="168" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#ecf0f1">update()</text>
  
  <rect x="640" y="195" width="260" height="80" rx="5" fill="#fff" stroke="#e0e0e0" stroke-width="1"/>
  <text x="660" y="215" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="#2c3e50">Pipeline de Renderizado</text>
  <text x="660" y="232" font-family="Arial, sans-serif" font-size="9" fill="#7f8c8d">1. Recepción JSON → parse</text>
  <text x="660" y="247" font-family="Arial, sans-serif" font-size="9" fill="#7f8c8d">2. Inserción en buffer circular (500 pts)</text>
  <text x="660" y="262" font-family="Arial, sans-serif" font-size="9" fill="#7f8c8d">3. Actualización canvas @60 fps</text>
  
  <rect x="640" y="290" width="260" height="50" rx="5" fill="#ecf0f1" stroke="#bdc3c7" stroke-width="1"/>
  <text x="660" y="310" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="#2c3e50">Comandos de Control</text>
  <text x="660" y="325" font-family="Courier New" font-size="9" fill="#8e44ad">{"cmd":"setHR","val":72}</text>
  
  <!-- Tabla de comparación -->
  <rect x="50" y="390" width="870" height="170" rx="8" fill="#f8f9fa" stroke="#bdc3c7" stroke-width="1"/>
  <text x="485" y="415" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="#2c3e50">Comparativa: WebSocket vs Alternativas HTTP</text>
  
  <!-- Headers tabla -->
  <line x1="60" y1="430" x2="910" y2="430" stroke="#bdc3c7" stroke-width="1"/>
  <text x="150" y="448" font-family="Arial, sans-serif" font-size="11" font-weight="bold" text-anchor="middle" fill="#2c3e50">Característica</text>
  <text x="350" y="448" font-family="Arial, sans-serif" font-size="11" font-weight="bold" text-anchor="middle" fill="#2c3e50">WebSocket ✓</text>
  <text x="550" y="448" font-family="Arial, sans-serif" font-size="11" font-weight="bold" text-anchor="middle" fill="#2c3e50">HTTP Polling</text>
  <text x="750" y="448" font-family="Arial, sans-serif" font-size="11" font-weight="bold" text-anchor="middle" fill="#2c3e50">Server-Sent Events</text>
  <line x1="60" y1="458" x2="910" y2="458" stroke="#bdc3c7" stroke-width="1"/>
  
  <!-- Líneas verticales -->
  <line x1="250" y1="430" x2="250" y2="550" stroke="#bdc3c7" stroke-width="1"/>
  <line x1="450" y1="430" x2="450" y2="550" stroke="#bdc3c7" stroke-width="1"/>
  <line x1="650" y1="430" x2="650" y2="550" stroke="#bdc3c7" stroke-width="1"/>
  
  <!-- Datos tabla -->
  <text x="150" y="478" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#2c3e50">Latencia</text>
  <text x="350" y="478" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#27ae60">&lt;50 ms</text>
  <text x="550" y="478" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#e74c3c">100-500 ms</text>
  <text x="750" y="478" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#f39c12">50-100 ms</text>
  
  <text x="150" y="498" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#2c3e50">Bidireccional</text>
  <text x="350" y="498" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#27ae60">Sí (full-duplex)</text>
  <text x="550" y="498" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#e74c3c">No (request/response)</text>
  <text x="750" y="498" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#e74c3c">No (server → client)</text>
  
  <text x="150" y="518" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#2c3e50">Overhead/mensaje</text>
  <text x="350" y="518" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#27ae60">2-6 bytes</text>
  <text x="550" y="518" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#e74c3c">~800 bytes headers</text>
  <text x="750" y="518" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#f39c12">~100 bytes</text>
  
  <text x="150" y="538" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#2c3e50">Conexión</text>
  <text x="350" y="538" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#27ae60">Persistente</text>
  <text x="550" y="538" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#e74c3c">Reconexión cada request</text>
  <text x="750" y="538" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#27ae60">Persistente</text>
  
  <!-- Métricas de ancho de banda -->
  <rect x="50" y="580" width="420" height="160" rx="8" fill="#fff3e0" stroke="#e67e22" stroke-width="2"/>
  <text x="260" y="605" font-family="Arial, sans-serif" font-size="13" font-weight="bold" text-anchor="middle" fill="#d35400">Análisis de Ancho de Banda</text>
  
  <text x="70" y="630" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="#2c3e50">Cálculo por mensaje:</text>
  <text x="70" y="650" font-family="Courier New" font-size="9" fill="#7f8c8d">{"t":"ecg","v":0.85,"ts":1234567890}</text>
  <text x="70" y="668" font-family="Arial, sans-serif" font-size="10" fill="#2c3e50">≈ 35 bytes/mensaje × 100 msg/s = 3.5 KB/s</text>
  
  <text x="70" y="695" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="#2c3e50">Throughput requerido:</text>
  <text x="70" y="713" font-family="Arial, sans-serif" font-size="10" fill="#2c3e50">3.5 KB/s × 8 = 28 Kbps (de 11 Mbps WiFi = 0.25%)</text>
  <text x="70" y="730" font-family="Arial, sans-serif" font-size="10" fill="#27ae60" font-weight="bold">✓ Margen amplio para múltiples clientes</text>
  
  <!-- Diagrama de secuencia simplificado -->
  <rect x="500" y="580" width="420" height="160" rx="8" fill="#e8f8f5" stroke="#1abc9c" stroke-width="2"/>
  <text x="710" y="605" font-family="Arial, sans-serif" font-size="13" font-weight="bold" text-anchor="middle" fill="#16a085">Secuencia de Establecimiento</text>
  
  <g font-family="Arial, sans-serif" font-size="9">
    <text x="550" y="625" fill="#7f8c8d">Cliente</text>
    <text x="820" y="625" fill="#7f8c8d">Servidor</text>
    <line x1="570" y1="630" x2="570" y2="730" stroke="#7f8c8d" stroke-width="1"/>
    <line x1="850" y1="630" x2="850" y2="730" stroke="#7f8c8d" stroke-width="1"/>
    
    <line x1="570" y1="645" x2="850" y2="645" stroke="#3498db" stroke-width="1" marker-end="url(#arrow)"/>
    <text x="710" y="642" text-anchor="middle" fill="#3498db">HTTP Upgrade: websocket</text>
    
    <line x1="850" y1="665" x2="570" y2="665" stroke="#27ae60" stroke-width="1" marker-end="url(#arrow)"/>
    <text x="710" y="662" text-anchor="middle" fill="#27ae60">101 Switching Protocols</text>
    
    <line x1="850" y1="690" x2="570" y2="690" stroke="#27ae60" stroke-width="1" marker-end="url(#arrow)"/>
    <text x="710" y="687" text-anchor="middle" fill="#27ae60">Stream: {"t":"ecg",...}</text>
    
    <line x1="570" y1="715" x2="850" y2="715" stroke="#e74c3c" stroke-width="1" marker-end="url(#arrow)"/>
    <text x="710" y="712" text-anchor="middle" fill="#e74c3c">Cmd: {"cmd":"setHR"}</text>
  </g>
</svg>
