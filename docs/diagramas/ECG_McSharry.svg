<svg xmlns="http://www.w3.org/2000/svg" width="600" height="900" viewBox="0 0 600 900">
  <style>
    .title { font: bold 18px Arial; }
    .subtitle { font: 13px Arial; fill: #666; }
    .box-text { font: 10px Arial; }
    .box-bold { font: bold 10px Arial; }
    .box-code { font: 9px Courier New; }
    .label { font: bold 9px Arial; fill: #c00; }
  </style>
  
  <rect width="100%" height="100%" fill="white"/>
  
  <text x="300" y="30" text-anchor="middle" class="title">ECG – Modelo dinámico McSharry 2003</text>
  <text x="300" y="48" text-anchor="middle" class="subtitle">Flujo de generación de señal electrocardiográfica</text>
  
  <!-- deltaTime -->
  <rect x="225" y="65" width="150" height="28" rx="4" fill="#d5d5d5" stroke="#333" stroke-width="1.5"/>
  <text x="300" y="84" text-anchor="middle" class="box-bold">deltaTime</text>
  <path d="M300 93 L300 108 L296 103 M300 108 L304 103" stroke="#333" stroke-width="1.5" fill="none"/>
  
  <!-- generateSample -->
  <rect x="175" y="113" width="250" height="28" rx="3" fill="#e8e8e8" stroke="#333" stroke-width="1.5"/>
  <text x="300" y="132" text-anchor="middle" class="box-bold">generateSample(deltaTime)</text>
  <path d="M300 141 L300 156 L296 151 M300 156 L304 151" stroke="#333" stroke-width="1.5" fill="none"/>
  
  <!-- Decision VFib -->
  <rect x="140" y="161" width="320" height="30" rx="3" fill="#fff3cd" stroke="#b8860b" stroke-width="1.5"/>
  <text x="300" y="181" text-anchor="middle" class="box-text">¿Condición = VENTRICULAR_FIBRILLATION?</text>
  
  <text x="175" y="207" class="label">SÍ</text>
  <text x="405" y="207" class="label">NO</text>
  <line x1="210" y1="191" x2="175" y2="218" stroke="#333" stroke-width="1.5"/>
  <line x1="390" y1="191" x2="425" y2="218" stroke="#333" stroke-width="1.5"/>
  
  <!-- VFib -->
  <rect x="95" y="223" width="160" height="38" rx="3" fill="#f5f5f5" stroke="#333" stroke-width="1.5"/>
  <text x="175" y="240" text-anchor="middle" class="box-text">generateVFibSample()</text>
  <text x="175" y="254" text-anchor="middle" style="font:8px Arial;fill:#666">(modelo espectral)</text>
  
  <!-- Omega -->
  <rect x="345" y="223" width="160" height="32" rx="3" fill="#e0e0e0" stroke="#333" stroke-width="1.5"/>
  <text x="425" y="244" text-anchor="middle" class="box-code">ω = 2π / currentRR</text>
  
  <line x1="175" y1="261" x2="300" y2="290" stroke="#333" stroke-width="1.5"/>
  <line x1="425" y1="255" x2="300" y2="290" stroke="#333" stroke-width="1.5"/>
  <polygon points="300,295 296,288 304,288" fill="#333"/>
  
  <!-- RK4 -->
  <rect x="150" y="300" width="300" height="72" rx="3" fill="#e8e8e8" stroke="#333" stroke-width="1.5"/>
  <text x="300" y="318" text-anchor="middle" class="box-bold">rungeKutta4Step(dt, ω)</text>
  <text x="300" y="335" text-anchor="middle" class="box-code">dx/dt = αx − ωy</text>
  <text x="300" y="350" text-anchor="middle" class="box-code">dy/dt = αy + ωx</text>
  <text x="300" y="365" text-anchor="middle" style="font:8px Courier New">dz/dt = −Σ aᵢ Δθᵢ exp(−Δθᵢ²/2bᵢ²) − (z − z₀)</text>
  <path d="M300 372 L300 387 L296 382 M300 387 L304 382" stroke="#333" stroke-width="1.5" fill="none"/>
  
  <!-- Decision latido -->
  <rect x="175" y="392" width="250" height="28" rx="3" fill="#fff3cd" stroke="#b8860b" stroke-width="1.5"/>
  <text x="300" y="411" text-anchor="middle" class="box-text">¿Cruce θ = 0? (nuevo latido)</text>
  <text x="315" y="435" class="label">SÍ</text>
  <path d="M300 420 L300 440 L296 435 M300 440 L304 435" stroke="#333" stroke-width="1.5" fill="none"/>
  
  <!-- detectNewBeat -->
  <rect x="155" y="445" width="290" height="55" rx="3" fill="#f5f5f5" stroke="#333" stroke-width="1.5"/>
  <text x="300" y="462" text-anchor="middle" class="box-bold">detectNewBeat()</text>
  <text x="300" y="477" text-anchor="middle" style="font:8px Arial">• Actualizar beatCount  • Generar nuevo RR (HRV)</text>
  <text x="300" y="492" text-anchor="middle" style="font:8px Arial">• Medir métricas PQRST  • Aplicar parámetros pending</text>
  <path d="M300 500 L300 515 L296 510 M300 515 L304 510" stroke="#333" stroke-width="1.5" fill="none"/>
  
  <!-- Decision calibrated -->
  <rect x="175" y="520" width="250" height="26" rx="3" fill="#fff3cd" stroke="#b8860b" stroke-width="1.5"/>
  <text x="300" y="538" text-anchor="middle" class="box-text">¿isCalibrated = true?</text>
  
  <text x="155" y="563" class="label">NO</text>
  <text x="430" y="563" class="label">SÍ</text>
  <line x1="210" y1="546" x2="170" y2="573" stroke="#333" stroke-width="1.5"/>
  <line x1="390" y1="546" x2="430" y2="573" stroke="#333" stroke-width="1.5"/>
  
  <rect x="90" y="578" width="160" height="35" rx="3" fill="#f5f5f5" stroke="#333" stroke-width="1.5"/>
  <text x="170" y="593" text-anchor="middle" class="box-text">updateCalibrationBuffer()</text>
  <text x="170" y="607" text-anchor="middle" style="font:8px Arial;fill:#666">(3 latidos)</text>
  
  <rect x="350" y="578" width="160" height="32" rx="3" fill="#e0e0e0" stroke="#333" stroke-width="1.5"/>
  <text x="430" y="599" text-anchor="middle" class="box-code">z_mV = (z−baseline)×G</text>
  
  <line x1="170" y1="613" x2="300" y2="640" stroke="#333" stroke-width="1.5"/>
  <line x1="430" y1="610" x2="300" y2="640" stroke="#333" stroke-width="1.5"/>
  <polygon points="300,645 296,638 304,638" fill="#333"/>
  
  <!-- Noise -->
  <rect x="175" y="650" width="250" height="26" rx="3" fill="#f5f5f5" stroke="#333" stroke-width="1.5"/>
  <text x="300" y="668" text-anchor="middle" class="box-text">z_mV += noise × gaussian()</text>
  <path d="M300 676 L300 691 L296 686 M300 691 L304 686" stroke="#333" stroke-width="1.5" fill="none"/>
  
  <!-- Output range -->
  <rect x="175" y="696" width="250" height="28" rx="3" fill="#d4edda" stroke="#198754" stroke-width="1.5"/>
  <text x="300" y="715" text-anchor="middle" class="box-bold">Rango fisiológico: −0.5 a +1.5 mV</text>
  
  <line x1="230" y1="724" x2="170" y2="750" stroke="#333" stroke-width="1.5"/>
  <line x1="370" y1="724" x2="430" y2="750" stroke="#333" stroke-width="1.5"/>
  
  <!-- getDACValue -->
  <rect x="70" y="755" width="200" height="85" rx="3" fill="#e8e8e8" stroke="#333" stroke-width="1.5"/>
  <text x="170" y="773" text-anchor="middle" class="box-bold">getDACValue()</text>
  <text x="170" y="790" text-anchor="middle" class="box-text">→ 0-255 → salida 0-3.3V</text>
  <text x="170" y="810" text-anchor="middle" class="box-code">DAC = (mV+0.5)/2.0 × 255</text>
  <text x="170" y="830" text-anchor="middle" style="font:8px Arial;fill:#666">Ej: R=+1.0mV → 191 → 2.47V</text>
  
  <!-- getWaveformValue -->
  <rect x="330" y="755" width="200" height="85" rx="3" fill="#e8e8e8" stroke="#333" stroke-width="1.5"/>
  <text x="430" y="773" text-anchor="middle" class="box-bold">getWaveformValue()</text>
  <text x="430" y="790" text-anchor="middle" class="box-text">→ píxeles Nextion</text>
  <text x="430" y="810" text-anchor="middle" class="box-code">px = map(val, 0, 255, 10, 370)</text>
  
  <text x="300" y="870" text-anchor="middle" style="font:9px Arial;fill:#999">BioSimulator Pro v1.0.0</text>
</svg>
