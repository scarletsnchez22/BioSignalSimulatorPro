<svg xmlns="http://www.w3.org/2000/svg" width="620" height="1000" viewBox="0 0 620 1000">
  <style>
    .title { font: bold 18px Arial; }
    .subtitle { font: 13px Arial; fill: #666; }
    .box-text { font: 10px Arial; }
    .box-bold { font: bold 10px Arial; }
    .box-code { font: 9px Courier New; }
    .label { font: bold 9px Arial; fill: #c00; }
    .note { font: 8px Arial; fill: #666; }
  </style>
  
  <rect width="100%" height="100%" fill="white"/>
  
  <!-- Header -->
  <text x="310" y="30" text-anchor="middle" class="title">ECG – Modelo dinámico McSharry 2003</text>
  <text x="310" y="48" text-anchor="middle" class="subtitle">Flujo de generación de señal electrocardiográfica</text>
  
  <!-- Frecuencia de muestreo -->
  <rect x="200" y="60" width="220" height="22" rx="3" fill="#e3f2fd" stroke="#1976d2" stroke-width="1"/>
  <text x="310" y="76" text-anchor="middle" class="box-text">Fs_modelo = 300 Hz  •  Upsampling 7:1 → 2 kHz DAC</text>
  
  <!-- deltaTime -->
  <rect x="235" y="95" width="150" height="28" rx="4" fill="#d5d5d5" stroke="#333" stroke-width="1.5"/>
  <text x="310" y="114" text-anchor="middle" class="box-bold">deltaTime = 3.33 ms</text>
  <path d="M310 123 L310 138 L306 133 M310 138 L314 133" stroke="#333" stroke-width="1.5" fill="none"/>
  
  <!-- generateSample -->
  <rect x="185" y="143" width="250" height="28" rx="3" fill="#e8e8e8" stroke="#333" stroke-width="1.5"/>
  <text x="310" y="162" text-anchor="middle" class="box-bold">generateSample(deltaTime)</text>
  <path d="M310 171 L310 186 L306 181 M310 186 L314 181" stroke="#333" stroke-width="1.5" fill="none"/>
  
  <!-- Decision VFib -->
  <rect x="150" y="191" width="320" height="30" rx="3" fill="#fff3cd" stroke="#b8860b" stroke-width="1.5"/>
  <text x="310" y="211" text-anchor="middle" class="box-text">¿Condición = VENTRICULAR_FIBRILLATION?</text>
  
  <text x="185" y="237" class="label">SÍ</text>
  <text x="415" y="237" class="label">NO</text>
  <line x1="220" y1="221" x2="185" y2="248" stroke="#333" stroke-width="1.5"/>
  <line x1="400" y1="221" x2="435" y2="248" stroke="#333" stroke-width="1.5"/>
  
  <!-- VFib -->
  <rect x="105" y="253" width="160" height="38" rx="3" fill="#f5f5f5" stroke="#333" stroke-width="1.5"/>
  <text x="185" y="270" text-anchor="middle" class="box-text">generateVFibSample()</text>
  <text x="185" y="284" text-anchor="middle" class="note">(modelo espectral caótico)</text>
  
  <!-- Omega -->
  <rect x="355" y="253" width="160" height="32" rx="3" fill="#e0e0e0" stroke="#333" stroke-width="1.5"/>
  <text x="435" y="274" text-anchor="middle" class="box-code">ω = 2π / currentRR</text>
  
  <line x1="185" y1="291" x2="310" y2="315" stroke="#333" stroke-width="1.5"/>
  <line x1="435" y1="285" x2="310" y2="315" stroke="#333" stroke-width="1.5"/>
  <polygon points="310,320 306,313 314,313" fill="#333"/>
  
  <!-- RK4 -->
  <rect x="140" y="325" width="340" height="82" rx="3" fill="#e8e8e8" stroke="#333" stroke-width="1.5"/>
  <text x="310" y="343" text-anchor="middle" class="box-bold">rungeKutta4Step(dt, ω)</text>
  <text x="310" y="360" text-anchor="middle" class="box-code">dx/dt = αx − ωy</text>
  <text x="310" y="375" text-anchor="middle" class="box-code">dy/dt = αy + ωx</text>
  <text x="310" y="390" text-anchor="middle" class="box-code">dz/dt = −Σ aᵢ Δθᵢ exp(−Δθᵢ²/2bᵢ²) − (z − z₀)</text>
  <text x="310" y="403" text-anchor="middle" class="note">P, Q, R, S, T: 5 gaussianas con a, b, θ configurables</text>
  <path d="M310 407 L310 422 L306 417 M310 422 L314 417" stroke="#333" stroke-width="1.5" fill="none"/>
  
  <!-- Decision latido -->
  <rect x="185" y="427" width="250" height="28" rx="3" fill="#fff3cd" stroke="#b8860b" stroke-width="1.5"/>
  <text x="310" y="446" text-anchor="middle" class="box-text">¿Cruce θ = 0? (nuevo latido)</text>
  <text x="325" y="470" class="label">SÍ</text>
  <path d="M310 455 L310 475 L306 470 M310 475 L314 470" stroke="#333" stroke-width="1.5" fill="none"/>
  
  <!-- detectNewBeat -->
  <rect x="155" y="480" width="310" height="55" rx="3" fill="#f5f5f5" stroke="#333" stroke-width="1.5"/>
  <text x="310" y="497" text-anchor="middle" class="box-bold">detectNewBeat()</text>
  <text x="310" y="512" text-anchor="middle" class="note">• Actualizar beatCount  • Generar nuevo RR (HRV)</text>
  <text x="310" y="527" text-anchor="middle" class="note">• Medir métricas PQRST  • Aplicar parámetros pending</text>
  <path d="M310 535 L310 550 L306 545 M310 550 L314 545" stroke="#333" stroke-width="1.5" fill="none"/>
  
  <!-- Decision calibrated -->
  <rect x="185" y="555" width="250" height="26" rx="3" fill="#fff3cd" stroke="#b8860b" stroke-width="1.5"/>
  <text x="310" y="573" text-anchor="middle" class="box-text">¿isCalibrated = true?</text>
  
  <text x="165" y="598" class="label">NO</text>
  <text x="440" y="598" class="label">SÍ</text>
  <line x1="220" y1="581" x2="180" y2="608" stroke="#333" stroke-width="1.5"/>
  <line x1="400" y1="581" x2="440" y2="608" stroke="#333" stroke-width="1.5"/>
  
  <rect x="100" y="613" width="160" height="35" rx="3" fill="#f5f5f5" stroke="#333" stroke-width="1.5"/>
  <text x="180" y="628" text-anchor="middle" class="box-text">updateCalibrationBuffer()</text>
  <text x="180" y="642" text-anchor="middle" class="note">(3 latidos → G, baseline)</text>
  
  <rect x="360" y="613" width="160" height="32" rx="3" fill="#e0e0e0" stroke="#333" stroke-width="1.5"/>
  <text x="440" y="634" text-anchor="middle" class="box-code">z_mV = G×(z−baseline)</text>
  
  <line x1="180" y1="648" x2="310" y2="670" stroke="#333" stroke-width="1.5"/>
  <line x1="440" y1="645" x2="310" y2="670" stroke="#333" stroke-width="1.5"/>
  <polygon points="310,675 306,668 314,668" fill="#333"/>
  
  <!-- Corregir baseline -->
  <rect x="185" y="680" width="250" height="26" rx="3" fill="#f5f5f5" stroke="#333" stroke-width="1.5"/>
  <text x="310" y="698" text-anchor="middle" class="box-text">z_mV −= currentBaseline_mV</text>
  <path d="M310 706 L310 721 L306 716 M310 721 L314 716" stroke="#333" stroke-width="1.5" fill="none"/>
  
  <!-- ST offset -->
  <rect x="165" y="726" width="290" height="26" rx="3" fill="#fce4ec" stroke="#c2185b" stroke-width="1.5"/>
  <text x="310" y="744" text-anchor="middle" class="box-text">Aplicar stOffset_mV (STEMI/Isquemia)</text>
  <path d="M310 752 L310 767 L306 762 M310 767 L314 762" stroke="#333" stroke-width="1.5" fill="none"/>
  
  <!-- Noise -->
  <rect x="185" y="772" width="250" height="26" rx="3" fill="#f5f5f5" stroke="#333" stroke-width="1.5"/>
  <text x="310" y="790" text-anchor="middle" class="box-text">z_mV += noise × gaussian()</text>
  <path d="M310 798 L310 813 L306 808 M310 813 L314 808" stroke="#333" stroke-width="1.5" fill="none"/>
  
  <!-- Output range -->
  <rect x="175" y="818" width="270" height="32" rx="3" fill="#d4edda" stroke="#198754" stroke-width="1.5"/>
  <text x="310" y="835" text-anchor="middle" class="box-bold">Rango fisiológico: −0.5 a +1.5 mV</text>
  <text x="310" y="846" text-anchor="middle" class="note">2 mV span → resolución 7.8 µV/bit</text>
  
  <line x1="230" y1="850" x2="170" y2="878" stroke="#333" stroke-width="1.5"/>
  <line x1="390" y1="850" x2="450" y2="878" stroke="#333" stroke-width="1.5"/>
  
  <!-- getDACValue -->
  <rect x="70" y="883" width="200" height="80" rx="3" fill="#e8e8e8" stroke="#333" stroke-width="1.5"/>
  <text x="170" y="901" text-anchor="middle" class="box-bold">getDACValue()</text>
  <text x="170" y="918" text-anchor="middle" class="box-text">Salida analógica 0-3.3V</text>
  <text x="170" y="938" text-anchor="middle" class="box-code">DAC = (mV+0.5)/2.0 × 255</text>
  <text x="170" y="955" text-anchor="middle" class="note">−0.5mV→0  0.5mV→128  1.5mV→255</text>
  
  <!-- getWaveformValue -->
  <rect x="350" y="883" width="200" height="80" rx="3" fill="#e8e8e8" stroke="#333" stroke-width="1.5"/>
  <text x="450" y="901" text-anchor="middle" class="box-bold">getWaveformValue()</text>
  <text x="450" y="918" text-anchor="middle" class="box-text">Nextion waveform (0-255)</text>
  <text x="450" y="938" text-anchor="middle" class="box-code">val = (mV+0.5)/2.0 × 255</text>
  <text x="450" y="955" text-anchor="middle" class="note">Display @ 200 Hz (downsample 10:1)</text>
  
  <text x="310" y="985" text-anchor="middle" style="font:9px Arial;fill:#999">BioSimulator Pro v1.0.0 – ECG McSharry ECGSYN</text>
</svg>
