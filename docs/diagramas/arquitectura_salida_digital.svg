<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1100 580" width="1100" height="580">
  <defs>
    <marker id="arrow" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#555"/>
    </marker>
  </defs>
  
  <!-- Fondo -->
  <rect width="1100" height="580" fill="#ffffff"/>
  
  <!-- Título -->
  <text x="550" y="28" font-family="Arial, sans-serif" font-size="16" font-weight="bold" fill="#333" text-anchor="middle" font-style="italic">
    Arquitectura de Salida Digital — Flujo de Datos desde Modelos hasta Interfaces
  </text>
  
  <!-- ═══════════════════════════════════════════════════════════════════════ -->
  <!-- CAPA 1: GENERACIÓN (Core 1) -->
  <!-- ═══════════════════════════════════════════════════════════════════════ -->
  
  <text x="25" y="100" font-family="Arial, sans-serif" font-size="10" fill="#1565C0" font-style="italic" writing-mode="tb">Core 1 — Generación</text>
  
  <rect x="50" y="50" width="1000" height="100" rx="6" fill="none" stroke="#666" stroke-width="1.5" stroke-dasharray="6,3"/>
  
  <!-- Modelo ECG -->
  <rect x="70" y="68" width="120" height="64" rx="4" fill="#fff" stroke="#555" stroke-width="1"/>
  <text x="130" y="88" font-family="Arial, sans-serif" font-size="9" fill="#2e7d32" text-anchor="middle" font-weight="bold">ECG Model</text>
  <text x="130" y="102" font-family="Arial, sans-serif" font-size="8" fill="#666" text-anchor="middle">McSharry 300 Hz</text>
  <text x="130" y="114" font-family="Arial, sans-serif" font-size="8" fill="#666" text-anchor="middle">Rango [-0.5, +1.5] mV</text>
  <text x="130" y="126" font-family="Arial, sans-serif" font-size="7" fill="#999" text-anchor="middle">Ratio 4000/300≈13.3</text>
  
  <!-- Modelo EMG -->
  <rect x="210" y="68" width="120" height="64" rx="4" fill="#fff" stroke="#555" stroke-width="1"/>
  <text x="270" y="88" font-family="Arial, sans-serif" font-size="9" fill="#e65100" text-anchor="middle" font-weight="bold">EMG Model</text>
  <text x="270" y="102" font-family="Arial, sans-serif" font-size="8" fill="#666" text-anchor="middle">Fuglevand 1000 Hz</text>
  <text x="270" y="114" font-family="Arial, sans-serif" font-size="8" fill="#666" text-anchor="middle">Rango [-5.0, +5.0] mV</text>
  <text x="270" y="126" font-family="Arial, sans-serif" font-size="7" fill="#999" text-anchor="middle">Ratio 4000/1000=4</text>
  
  <!-- Modelo PPG -->
  <rect x="350" y="68" width="120" height="64" rx="4" fill="#fff" stroke="#555" stroke-width="1"/>
  <text x="410" y="88" font-family="Arial, sans-serif" font-size="9" fill="#1565c0" text-anchor="middle" font-weight="bold">PPG Model</text>
  <text x="410" y="102" font-family="Arial, sans-serif" font-size="8" fill="#666" text-anchor="middle">Gaussiano 100 Hz</text>
  <text x="410" y="114" font-family="Arial, sans-serif" font-size="8" fill="#666" text-anchor="middle">Rango [0, 150] mV AC</text>
  <text x="410" y="126" font-family="Arial, sans-serif" font-size="7" fill="#999" text-anchor="middle">Ratio 4000/100=40</text>
  
  <!-- Flecha modelos → interpolador -->
  <line x1="470" y1="100" x2="518" y2="100" stroke="#555" stroke-width="1.5" marker-end="url(#arrow)"/>
  
  <!-- Interpolador -->
  <rect x="530" y="68" width="140" height="64" rx="4" fill="#f5f5f5" stroke="#555" stroke-width="1"/>
  <text x="600" y="88" font-family="Arial, sans-serif" font-size="9" fill="#7b1fa2" text-anchor="middle" font-weight="bold">Interpolación Lineal</text>
  <text x="600" y="102" font-family="Arial, sans-serif" font-size="8" fill="#666" text-anchor="middle">y = y₀ + (y₁−y₀)·α</text>
  <text x="600" y="116" font-family="Arial, sans-serif" font-size="8" fill="#666" text-anchor="middle">Upsampling → 4000 Hz</text>
  <text x="600" y="128" font-family="Arial, sans-serif" font-size="7" fill="#999" text-anchor="middle">Ts = 250 µs uniforme</text>
  
  <!-- Flecha interpolador → buffer -->
  <line x1="670" y1="100" x2="718" y2="100" stroke="#555" stroke-width="1.5" marker-end="url(#arrow)"/>
  
  <!-- Buffer Circular -->
  <rect x="730" y="68" width="140" height="64" rx="4" fill="#fff" stroke="#555" stroke-width="1"/>
  <text x="800" y="88" font-family="Arial, sans-serif" font-size="9" fill="#388e3c" text-anchor="middle" font-weight="bold">Buffer Circular</text>
  <text x="800" y="102" font-family="Arial, sans-serif" font-size="8" fill="#666" text-anchor="middle">2048 muestras DRAM</text>
  <text x="800" y="114" font-family="Arial, sans-serif" font-size="8" fill="#666" text-anchor="middle">uint8_t DRAM_ATTR</text>
  <text x="800" y="126" font-family="Arial, sans-serif" font-size="7" fill="#999" text-anchor="middle">Autonomía 512 ms</text>
  
  <!-- Flecha buffer → timer -->
  <line x1="870" y1="100" x2="918" y2="100" stroke="#555" stroke-width="1.5" marker-end="url(#arrow)"/>
  
  <!-- Timer ISR -->
  <rect x="930" y="68" width="100" height="64" rx="4" fill="#fff" stroke="#c62828" stroke-width="1.5"/>
  <text x="980" y="88" font-family="Arial, sans-serif" font-size="9" fill="#c62828" text-anchor="middle" font-weight="bold">Timer ISR</text>
  <text x="980" y="102" font-family="Arial, sans-serif" font-size="8" fill="#666" text-anchor="middle">4 kHz (250 µs)</text>
  <text x="980" y="114" font-family="Arial, sans-serif" font-size="8" fill="#666" text-anchor="middle">IRAM_ATTR</text>
  <text x="980" y="126" font-family="Arial, sans-serif" font-size="7" fill="#999" text-anchor="middle">Jitter &lt;5 µs</text>
  
  <!-- ═══════════════════════════════════════════════════════════════════════ -->
  <!-- NODO DE BIFURCACIÓN -->
  <!-- ═══════════════════════════════════════════════════════════════════════ -->
  
  <!-- Línea vertical desde Timer ISR hacia abajo -->
  <line x1="980" y1="132" x2="980" y2="175" stroke="#555" stroke-width="2"/>
  
  <!-- Nodo de bifurcación -->
  <circle cx="980" cy="175" r="5" fill="#555"/>
  
  <!-- ═══════════════════════════════════════════════════════════════════════ -->
  <!-- RAMA IZQUIERDA: DAC (sin decimación) -->
  <!-- ═══════════════════════════════════════════════════════════════════════ -->
  
  <text x="25" y="265" font-family="Arial, sans-serif" font-size="10" fill="#c62828" font-style="italic" writing-mode="tb">Salida DAC 4 kHz</text>
  
  <rect x="50" y="195" width="400" height="135" rx="6" fill="none" stroke="#c62828" stroke-width="1.5" stroke-dasharray="6,3"/>
  
  <!-- Línea horizontal desde nodo hacia escalado DAC -->
  <line x1="980" y1="175" x2="500" y2="175" stroke="#c62828" stroke-width="1.5"/>
  <line x1="500" y1="175" x2="500" y2="215" stroke="#c62828" stroke-width="1.5"/>
  <line x1="500" y1="215" x2="448" y2="215" stroke="#c62828" stroke-width="1.5" marker-end="url(#arrow)"/>
  
  <!-- Escalado DAC -->
  <rect x="70" y="210" width="175" height="105" rx="4" fill="#fff" stroke="#555" stroke-width="1"/>
  <text x="157" y="228" font-family="Arial, sans-serif" font-size="9" fill="#c62828" text-anchor="middle" font-weight="bold">Escalado a DAC 8-bit</text>
  <text x="157" y="245" font-family="Arial, sans-serif" font-size="8" fill="#666" text-anchor="middle">ECG: (mV+0.5)×127.5</text>
  <text x="157" y="258" font-family="Arial, sans-serif" font-size="8" fill="#666" text-anchor="middle">EMG: (mV+5.0)×25.5</text>
  <text x="157" y="271" font-family="Arial, sans-serif" font-size="8" fill="#666" text-anchor="middle">PPG: mV×1.7</text>
  <text x="157" y="288" font-family="Arial, sans-serif" font-size="8" fill="#666" text-anchor="middle">Clamp [0, 255]</text>
  <text x="157" y="305" font-family="Arial, sans-serif" font-size="7" fill="#999" text-anchor="middle">Sin decimación: 4000 Hz nativo</text>
  
  <!-- Flecha escalado → DAC -->
  <line x1="245" y1="262" x2="283" y2="262" stroke="#555" stroke-width="1.5" marker-end="url(#arrow)"/>
  
  <!-- DAC GPIO25 -->
  <rect x="295" y="218" width="140" height="88" rx="4" fill="#fff" stroke="#c62828" stroke-width="1.5"/>
  <text x="365" y="240" font-family="Arial, sans-serif" font-size="10" fill="#c62828" text-anchor="middle" font-weight="bold">DAC GPIO25</text>
  <text x="365" y="258" font-family="Arial, sans-serif" font-size="8" fill="#666" text-anchor="middle">8 bits [0−255]</text>
  <text x="365" y="272" font-family="Arial, sans-serif" font-size="8" fill="#666" text-anchor="middle">Salida 0−3.3 V</text>
  <text x="365" y="286" font-family="Arial, sans-serif" font-size="7" fill="#999" text-anchor="middle">→ LM358 buffer</text>
  <text x="365" y="298" font-family="Arial, sans-serif" font-size="7" fill="#999" text-anchor="middle">→ CD4051 + RC</text>
  
  <!-- ═══════════════════════════════════════════════════════════════════════ -->
  <!-- RAMA DERECHA: NEXTION + WEBSOCKET (con decimación) -->
  <!-- ═══════════════════════════════════════════════════════════════════════ -->
  
  <text x="25" y="440" font-family="Arial, sans-serif" font-size="10" fill="#1976d2" font-style="italic" writing-mode="tb">Visualización Digital</text>
  
  <rect x="50" y="350" width="1000" height="130" rx="6" fill="none" stroke="#1976d2" stroke-width="1.5" stroke-dasharray="6,3"/>
  
  <!-- Línea vertical desde nodo hacia decimación -->
  <line x1="980" y1="175" x2="980" y2="350" stroke="#1976d2" stroke-width="1.5"/>
  <line x1="980" y1="350" x2="980" y2="368" stroke="#1976d2" stroke-width="1.5" marker-end="url(#arrow)"/>
  
  <!-- Decimación -->
  <rect x="70" y="365" width="200" height="100" rx="4" fill="#fff" stroke="#555" stroke-width="1"/>
  <text x="170" y="383" font-family="Arial, sans-serif" font-size="9" fill="#1976d2" text-anchor="middle" font-weight="bold">Decimación Selectiva</text>
  <text x="170" y="400" font-family="Courier New" font-size="8" fill="#666" text-anchor="middle">if (counter % ratio == 0)</text>
  <text x="170" y="418" font-family="Arial, sans-serif" font-size="8" fill="#666" text-anchor="middle">ECG: 20:1 → 200 Hz display</text>
  <text x="170" y="433" font-family="Arial, sans-serif" font-size="8" fill="#666" text-anchor="middle">EMG: 40:1 → 100 Hz display</text>
  <text x="170" y="448" font-family="Arial, sans-serif" font-size="8" fill="#666" text-anchor="middle">PPG: 40:1 → 100 Hz display</text>
  <text x="170" y="462" font-family="Arial, sans-serif" font-size="7" fill="#999" text-anchor="middle">Mismo valor, menor tasa</text>
  
  <!-- Flecha decimación → escalado waveform -->
  <line x1="270" y1="415" x2="308" y2="415" stroke="#555" stroke-width="1.5" marker-end="url(#arrow)"/>
  
  <!-- Escalado Waveform -->
  <rect x="320" y="375" width="180" height="80" rx="4" fill="#fff" stroke="#555" stroke-width="1"/>
  <text x="410" y="393" font-family="Arial, sans-serif" font-size="9" fill="#333" text-anchor="middle" font-weight="bold">Escalado Waveform</text>
  <text x="410" y="410" font-family="Arial, sans-serif" font-size="8" fill="#666" text-anchor="middle">mV → [0, 255] vertical</text>
  <text x="410" y="425" font-family="Arial, sans-serif" font-size="8" fill="#666" text-anchor="middle">Mismo mapeo que DAC</text>
  <text x="410" y="440" font-family="Arial, sans-serif" font-size="8" fill="#666" text-anchor="middle">uint8_t val = clamp()</text>
  <text x="410" y="452" font-family="Arial, sans-serif" font-size="7" fill="#999" text-anchor="middle">Altura: 380 px display</text>
  
  <!-- Flecha escalado → UART Nextion -->
  <line x1="500" y1="415" x2="538" y2="415" stroke="#555" stroke-width="1.5" marker-end="url(#arrow)"/>
  
  <!-- Comando UART Nextion -->
  <rect x="550" y="365" width="180" height="100" rx="4" fill="#fff" stroke="#1976d2" stroke-width="1"/>
  <text x="640" y="383" font-family="Arial, sans-serif" font-size="9" fill="#1976d2" text-anchor="middle" font-weight="bold">UART2 → Nextion</text>
  <text x="640" y="400" font-family="Courier New" font-size="8" fill="#666" text-anchor="middle">add 1,0,val\xFF\xFF\xFF</text>
  <text x="640" y="418" font-family="Arial, sans-serif" font-size="8" fill="#666" text-anchor="middle">115200 baud, 8N1</text>
  <text x="640" y="435" font-family="Arial, sans-serif" font-size="8" fill="#666" text-anchor="middle">~15 bytes/punto</text>
  <text x="640" y="450" font-family="Arial, sans-serif" font-size="7" fill="#999" text-anchor="middle">Waveform 700×380 px</text>
  <text x="640" y="462" font-family="Arial, sans-serif" font-size="7" fill="#999" text-anchor="middle">ECG 3.5s, EMG/PPG 7.0s</text>
  
  <!-- Flecha escalado → WebSocket -->
  <line x1="500" y1="440" x2="538" y2="440" stroke="#555" stroke-width="1" stroke-dasharray="4,2"/>
  <line x1="730" y1="440" x2="500" y2="440" stroke="#555" stroke-width="1" stroke-dasharray="4,2"/>
  <line x1="730" y1="440" x2="730" y2="390" stroke="#555" stroke-width="1" stroke-dasharray="4,2"/>
  <line x1="730" y1="390" x2="778" y2="390" stroke="#e65100" stroke-width="1.5" marker-end="url(#arrow)"/>
  
  <!-- WebSocket -->
  <rect x="790" y="365" width="180" height="100" rx="4" fill="#fff" stroke="#e65100" stroke-width="1"/>
  <text x="880" y="383" font-family="Arial, sans-serif" font-size="9" fill="#e65100" text-anchor="middle" font-weight="bold">WebSocket :81</text>
  <text x="880" y="400" font-family="Courier New" font-size="8" fill="#666" text-anchor="middle">{"t":"s","v":128}</text>
  <text x="880" y="418" font-family="Arial, sans-serif" font-size="8" fill="#666" text-anchor="middle">Decimación 40:1</text>
  <text x="880" y="435" font-family="Arial, sans-serif" font-size="8" fill="#666" text-anchor="middle">100 msg/s JSON</text>
  <text x="880" y="450" font-family="Arial, sans-serif" font-size="7" fill="#999" text-anchor="middle">Canvas 700×300 px</text>
  <text x="880" y="462" font-family="Arial, sans-serif" font-size="7" fill="#999" text-anchor="middle">Hasta 4 clientes</text>
  
  <!-- ═══════════════════════════════════════════════════════════════════════ -->
  <!-- DESTINOS FINALES -->
  <!-- ═══════════════════════════════════════════════════════════════════════ -->
  
  <!-- Destino BNC -->
  <rect x="70" y="510" width="140" height="45" rx="4" fill="#e8f5e9" stroke="#2e7d32" stroke-width="1.5"/>
  <text x="140" y="530" font-family="Arial, sans-serif" font-size="10" fill="#2e7d32" text-anchor="middle" font-weight="bold">Conector BNC</text>
  <text x="140" y="545" font-family="Arial, sans-serif" font-size="8" fill="#666" text-anchor="middle">Señal analógica 4 kHz</text>
  
  <line x1="365" y1="306" x2="365" y2="485" stroke="#2e7d32" stroke-width="1.5"/>
  <line x1="365" y1="485" x2="140" y2="485" stroke="#2e7d32" stroke-width="1.5"/>
  <line x1="140" y1="485" x2="140" y2="505" stroke="#2e7d32" stroke-width="1.5" marker-end="url(#arrow)"/>
  
  <!-- Destino Nextion -->
  <rect x="415" y="510" width="180" height="45" rx="4" fill="#e3f2fd" stroke="#1976d2" stroke-width="1.5"/>
  <text x="505" y="530" font-family="Arial, sans-serif" font-size="10" fill="#1976d2" text-anchor="middle" font-weight="bold">Nextion 700×380 px</text>
  <text x="505" y="545" font-family="Arial, sans-serif" font-size="8" fill="#666" text-anchor="middle">Waveform + Grid clínico</text>
  
  <line x1="640" y1="465" x2="640" y2="485" stroke="#1976d2" stroke-width="1.5"/>
  <line x1="640" y1="485" x2="505" y2="485" stroke="#1976d2" stroke-width="1.5"/>
  <line x1="505" y1="485" x2="505" y2="505" stroke="#1976d2" stroke-width="1.5" marker-end="url(#arrow)"/>
  
  <!-- Destino Browser -->
  <rect x="740" y="510" width="150" height="45" rx="4" fill="#fff3e0" stroke="#e65100" stroke-width="1.5"/>
  <text x="815" y="530" font-family="Arial, sans-serif" font-size="10" fill="#e65100" text-anchor="middle" font-weight="bold">Navegador Web</text>
  <text x="815" y="545" font-family="Arial, sans-serif" font-size="8" fill="#666" text-anchor="middle">Canvas 700×300 px</text>
  
  <line x1="880" y1="465" x2="880" y2="485" stroke="#e65100" stroke-width="1.5"/>
  <line x1="880" y1="485" x2="815" y2="485" stroke="#e65100" stroke-width="1.5"/>
  <line x1="815" y1="485" x2="815" y2="505" stroke="#e65100" stroke-width="1.5" marker-end="url(#arrow)"/>
  
</svg>
