<svg xmlns="http://www.w3.org/2000/svg" width="600" height="900" viewBox="0 0 600 900">
  <style>
    .title { font: bold 18px Arial; }
    .subtitle { font: 13px Arial; fill: #666; }
    .box-text { font: 10px Arial; }
    .box-bold { font: bold 10px Arial; }
    .box-code { font: 9px Courier New; }
    .label { font: bold 9px Arial; fill: #c00; }
  </style>
  
  <rect width="100%" height="100%" fill="white"/>
  
  <text x="300" y="30" text-anchor="middle" class="title">PPG – Modelo determinista Allen 2007</text>
  <text x="300" y="48" text-anchor="middle" class="subtitle">Flujo de generación de señal fotopletismográfica</text>
  
  <!-- deltaTime -->
  <rect x="225" y="65" width="150" height="28" rx="4" fill="#d5d5d5" stroke="#333" stroke-width="1.5"/>
  <text x="300" y="84" text-anchor="middle" class="box-bold">deltaTime</text>
  <path d="M300 93 L300 108 L296 103 M300 108 L304 103" stroke="#333" stroke-width="1.5" fill="none"/>
  
  <!-- generateSample -->
  <rect x="175" y="113" width="250" height="28" rx="3" fill="#e8e8e8" stroke="#333" stroke-width="1.5"/>
  <text x="300" y="132" text-anchor="middle" class="box-bold">generateSample(deltaTime)</text>
  <path d="M300 141 L300 156 L296 151 M300 156 L304 151" stroke="#333" stroke-width="1.5" fill="none"/>
  
  <!-- Condición -->
  <rect x="125" y="161" width="350" height="28" rx="3" fill="#f5f5f5" stroke="#333" stroke-width="1.5"/>
  <text x="300" y="180" text-anchor="middle" class="box-text">Condición PPG: normal, arritmia, perfusión débil, vasodilatación</text>
  <path d="M300 189 L300 204 L296 199 M300 204 L304 199" stroke="#333" stroke-width="1.5" fill="none"/>
  
  <!-- phaseInCycle -->
  <rect x="155" y="209" width="290" height="26" rx="3" fill="#e0e0e0" stroke="#333" stroke-width="1.5"/>
  <text x="300" y="227" text-anchor="middle" class="box-code">phaseInCycle += deltaTime / currentRR</text>
  <path d="M300 235 L300 250 L296 245 M300 250 L304 245" stroke="#333" stroke-width="1.5" fill="none"/>
  
  <!-- Decision nuevo latido -->
  <rect x="155" y="255" width="290" height="26" rx="3" fill="#fff3cd" stroke="#b8860b" stroke-width="1.5"/>
  <text x="300" y="273" text-anchor="middle" class="box-text">¿phaseInCycle ≥ 1.0? (nuevo latido)</text>
  <text x="315" y="297" class="label">SÍ</text>
  <path d="M300 281 L300 301 L296 296 M300 301 L304 296" stroke="#333" stroke-width="1.5" fill="none"/>
  
  <!-- detectBeat -->
  <rect x="135" y="306" width="330" height="58" rx="3" fill="#f5f5f5" stroke="#333" stroke-width="1.5"/>
  <text x="300" y="324" text-anchor="middle" class="box-bold">detectBeatAndApplyPending()</text>
  <text x="300" y="342" text-anchor="middle" class="box-text">• phaseInCycle −= 1.0  • currentHR = generateDynamicHR()</text>
  <text x="300" y="358" text-anchor="middle" class="box-text">• currentPI = generateDynamicPI()  • Aplicar parámetros pending</text>
  <path d="M300 364 L300 379 L296 374 M300 379 L304 374" stroke="#333" stroke-width="1.5" fill="none"/>
  
  <!-- computePulseShape -->
  <rect x="115" y="384" width="370" height="85" rx="3" fill="#e8e8e8" stroke="#333" stroke-width="1.5"/>
  <text x="300" y="402" text-anchor="middle" class="box-bold">computePulseShape(φ)</text>
  <text x="300" y="422" text-anchor="middle" class="box-code">Gₛ = exp(−(φ−0.15)²/2×0.055²)  sistólica</text>
  <text x="300" y="440" text-anchor="middle" class="box-code">G_d = exp(−(φ−0.40)²/2×0.10²)  diastólica</text>
  <text x="300" y="458" text-anchor="middle" class="box-code">Gₙ = exp(−(φ−0.30)²/2×0.02²)  muesca dicrótica</text>
  <text x="300" y="476" text-anchor="middle" class="box-code">pulse = Gₛ + 0.4×G_d − 0.25×Gₙ</text>
  <path d="M300 469 L300 489 L296 484 M300 489 L304 484" stroke="#333" stroke-width="1.5" fill="none"/>
  
  <!-- Modificadores -->
  <rect x="130" y="494" width="340" height="40" rx="3" fill="#f5f5f5" stroke="#333" stroke-width="1.5"/>
  <text x="300" y="512" text-anchor="middle" class="box-bold">Modificadores de condición</text>
  <text x="300" y="528" text-anchor="middle" class="box-text">WEAK_PERFUSION • VASODILATION • ARRHYTHMIA (CV>15%)</text>
  <path d="M300 534 L300 549 L296 544 M300 549 L304 544" stroke="#333" stroke-width="1.5" fill="none"/>
  
  <!-- AC calculation -->
  <rect x="155" y="554" width="290" height="40" rx="3" fill="#e0e0e0" stroke="#333" stroke-width="1.5"/>
  <text x="300" y="572" text-anchor="middle" class="box-bold">AC = currentPI × 15.0 mV/%</text>
  <text x="300" y="588" text-anchor="middle" style="font:8px Arial;fill:#666">(PI=3% → AC=45mV, PI=10% → AC=150mV)</text>
  <path d="M300 594 L300 609 L296 604 M300 609 L304 604" stroke="#333" stroke-width="1.5" fill="none"/>
  
  <!-- signal construction -->
  <rect x="145" y="614" width="310" height="28" rx="3" fill="#f5f5f5" stroke="#333" stroke-width="1.5"/>
  <text x="300" y="633" text-anchor="middle" class="box-text">signal = dcBaseline + pulse × AC + noise × gaussian()</text>
  <path d="M300 642 L300 657 L296 652 M300 657 L304 652" stroke="#333" stroke-width="1.5" fill="none"/>
  
  <!-- Output range -->
  <rect x="145" y="662" width="310" height="45" rx="3" fill="#d4edda" stroke="#198754" stroke-width="1.5"/>
  <text x="300" y="680" text-anchor="middle" class="box-bold">Rangos fisiológicos:</text>
  <text x="300" y="698" text-anchor="middle" class="box-text">Señal completa: 800-1200 mV  •  AC puro: −100 a +100 mV</text>
  
  <line x1="220" y1="707" x2="160" y2="740" stroke="#333" stroke-width="1.5"/>
  <line x1="380" y1="707" x2="440" y2="740" stroke="#333" stroke-width="1.5"/>
  
  <!-- getDACValue -->
  <rect x="60" y="745" width="200" height="90" rx="3" fill="#e8e8e8" stroke="#333" stroke-width="1.5"/>
  <text x="160" y="763" text-anchor="middle" class="box-bold">getDACValue()</text>
  <text x="160" y="780" text-anchor="middle" class="box-text">→ 0-255 → salida 0-3.3V</text>
  <text x="160" y="800" text-anchor="middle" class="box-code">DAC = (mV−800)/400 × 255</text>
  <text x="160" y="820" text-anchor="middle" style="font:8px Arial;fill:#666">Ej: 1050mV → DAC=159 → 2.06V</text>
  
  <!-- getWaveformValue -->
  <rect x="340" y="745" width="200" height="90" rx="3" fill="#e8e8e8" stroke="#333" stroke-width="1.5"/>
  <text x="440" y="763" text-anchor="middle" class="box-bold">getWaveformValue()</text>
  <text x="440" y="780" text-anchor="middle" class="box-text">→ Nextion (solo AC)</text>
  <text x="440" y="800" text-anchor="middle" class="box-code">val = (AC+100)/200 × 255</text>
  <text x="440" y="820" text-anchor="middle" style="font:8px Arial;fill:#666">Ej: AC=+50mV → val=191</text>
  
  <text x="300" y="860" text-anchor="middle" style="font:8px Arial;fill:#888">Muesca dicrótica: β (escala) y λ (atraso) según SpO₂ y condición vascular</text>
  <text x="300" y="880" text-anchor="middle" style="font:9px Arial;fill:#999">BioSimulator Pro v1.0.0</text>
</svg>
